@model List<ARManila.Models.ARWrapper>
@{
    ViewBag.Title = "AR History";
}

<div class="content">

    <nav class="breadcrumb push bg-body-extra-light rounded-pill px-4 py-2">
        <span class="breadcrumb-item">Student Menu</span>
        <span class="breadcrumb-item active">AR History</span>
    </nav>

    @using (Html.BeginForm("ARHistory", "ARQuery", FormMethod.Post))
    {
        <div class="row">
            <div class="col-sm-3">
                <div class="mb-4">
                    <input type="button" class="btn btn-sm rounded-pill btn-outline-danger"
                           id="studentfinderbutton" value="Student No Finder" />
                </div>
                <div class="mb-4">
                    <div class="input-group">
                        <input type="text" class="form-control" id="studentno" name="studentno"
                               placeholder="Student No" value="@ViewBag.StudentNo" />
                        <input type="submit" value="Search" class="btn btn-primary" id="search" />
                    </div>
                </div>
            </div>
            <div class="col-sm-9">
                @if (Model != null && Model.Any() && Model.First().Student != null)
                {
                    var first = Model.First().Student;
                    <div class="block block-rounded">
                        <div class="block-header block-header-default">
                            <h3 class="block-title">
                                <b>@first.StudentNumber</b> &mdash; @first.StudentName
                            </h3>
                            <div class="block-options">
                                <span class="badge bg-info">@Model.Count period(s)</span>
                            </div>
                        </div>
                        <div class="block-content pb-2">
                            <small class="text-muted">
                                @first.EducationalLevel &nbsp;|&nbsp; @first.Program
                            </small>
                        </div>
                    </div>
                }
                else if (Model != null && !Model.Any() && ViewBag.StudentNo != null)
                {
                    <div class="block block-rounded">
                        <div class="block-header block-header-default">
                            <h3 class="block-title fw-bold text-warning">
                                No enrollment history found for this student.
                            </h3>
                        </div>
                    </div>
                }
            </div>
        </div>
    }

    @if (Model != null && Model.Any())
    {
        for (int i = 0; i < Model.Count; i++)
        {
            var wrapper = Model[i];
            bool isFirst = (i == 0);
            string collapseId = "periodPanel" + i;
            string balanceClass = wrapper.TotalBalance.HasValue && wrapper.TotalBalance.Value > 0
                ? "text-danger" : "text-success";

            <div class="block block-rounded mb-2">
                <div class="block-header block-header-default"
                     style="cursor:pointer;"
                     data-bs-toggle="collapse"
                     data-bs-target="#@collapseId"
                     aria-expanded="@(isFirst ? "true" : "false")">
                    <h3 class="block-title d-flex align-items-center gap-3">
                        <i class="fa fa-calendar-alt text-muted"></i>
                        <span>@(wrapper.Student != null ? wrapper.Student.Period : "Unknown Period")</span>
                        @if (wrapper.Student != null)
                        {
                            <small class="text-muted fw-normal">&mdash; @wrapper.Student.Section</small>
                        }
                    </h3>
                    <div class="block-options">
                        @if (wrapper.TotalBalance.HasValue)
                        {
                            <span class="fw-semibold @balanceClass">
                                Balance: &#8369;@wrapper.TotalBalance.Value.ToString("#,##0.00")
                            </span>
                        }
                        <i class="fa fa-chevron-down ms-2 text-muted"></i>
                    </div>
                </div>

                <div id="@collapseId" class="collapse @(isFirst ? "show" : "")">
                    <div class="block-content">

                        @if (wrapper.ARItems != null && wrapper.ARItems.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-striped table-bordered table-hover table-sm">
                                    <thead>
                                        <tr class="bg-gray-light">
                                            <th>Particular</th>
                                            <th class="text-center">Debit</th>
                                            <th class="text-center">Credit</th>
                                            <th class="text-end">Doc No</th>
                                            <th class="text-center">Doc Date</th>
                                            <th class="text-center">Remark</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in wrapper.ARItems)
                                        {
                                            <tr>
                                                <td>@item.Particular</td>
                                                <td class="text-center">@(item.Debit == 0 ? "" : item.Debit.ToString("#,##0.00"))</td>
                                                <td class="text-center">@(item.Credit == 0 ? "" : item.Credit.ToString("#,##0.00"))</td>
                                                <td class="text-end">@item.DocumentNo</td>
                                                <td class="text-center">@(item.DocumentDate.HasValue ? item.DocumentDate.Value.ToShortDateString() : "")</td>
                                                <td class="text-center">@item.Remark</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            if (wrapper.ARDueDates != null && wrapper.ARDueDates.Any())
                            {
                                <div class="block block-themed mb-2">
                                    <div class="block-header bg-pulse-light">
                                        <h3 class="block-title">Schedule of Payments</h3>
                                    </div>
                                    <div class="block-content">
                                        <div class="table-responsive">
                                            <table class="table table-striped table-bordered table-sm">
                                                @foreach (var dd in wrapper.ARDueDates)
                                                {
                                                    <tr>
                                                        <td>@dd.Payment</td>
                                                        <td class="text-end">@dd.Amount.ToString("#,##0.00")</td>
                                                        <td class="text-end">@dd.DueDate</td>
                                                    </tr>
                                                }
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            }

                            <div class="row py-2 text-center border-top mt-2">
                                <div class="col-12 col-lg-4 border-end">
                                    <div class="fs-4 fw-semibold">
                                        &#8369;@(wrapper.TotalDebit.HasValue ? wrapper.TotalDebit.Value.ToString("#,##0.00") : "0.00")
                                    </div>
                                    <div class="fs-sm fw-semibold text-uppercase text-muted">Total Debit</div>
                                </div>
                                <div class="col-12 col-lg-4">
                                    <div class="fs-4 fw-semibold">
                                        &#8369;@(wrapper.TotalCredit.HasValue ? wrapper.TotalCredit.Value.ToString("#,##0.00") : "0.00")
                                    </div>
                                    <div class="fs-sm fw-semibold text-uppercase text-muted">Total Credit</div>
                                </div>
                                <div class="col-12 col-lg-4 border-start">
                                    <div class="fs-4 fw-semibold @balanceClass">
                                        &#8369;@(wrapper.TotalBalance.HasValue ? wrapper.TotalBalance.Value.ToString("#,##0.00") : "0.00")
                                    </div>
                                    <div class="fs-sm fw-semibold text-uppercase text-muted">Balance</div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <p class="text-muted py-2">No AR items found for this period.</p>
                        }

                    </div>
                </div>
            </div>
        }
    }

</div>

<!-- Student Finder Modal -->
<div class="modal" id="searchstudentmodal" tabindex="-1" role="dialog" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="block block-rounded shadow-none mb-0">
                <div class="block-header block-header-default">
                    <h3 class="block-title">Search Student</h3>
                    <div class="block-options">
                        <button type="button" class="btn-block-option" data-bs-dismiss="modal" aria-label="Close">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="block-content fs-sm">
                    <div class="mb-4">
                        <div class="input-group">
                            <input type="text" class="form-control" id="searchstudenttext"
                                   placeholder="Enter Lastname or Firstname" />
                            <button type="button" class="btn btn-primary" id="searchstudentbutton">
                                <i class="fa fa-search me-1"></i> Search
                            </button>
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="searchstudenttable" class="table table-striped table-bordered">
                            <thead>
                                <tr>
                                    <td>Student No</td>
                                    <td>Last Name</td>
                                    <td>First Name</td>
                                    <td>Program</td>
                                </tr>
                            </thead>
                        </table>
                    </div>
                </div>
                <div class="block-content block-content-full block-content-sm text-end border-top">
                    <button type="button" class="btn btn-alt-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script type="text/javascript">
        $(document).ready(function () {

            $("#studentno").keyup(function (e) {
                if (e.keyCode === 13) { $("#search").click(); }
            });

            $("#studentfinderbutton").click(function () {
                $("#searchstudenttext").val("");
                $("#searchstudenttable").find("tbody").remove();
                $("#searchstudentmodal").modal("show");
            });

            $("#searchstudentbutton").click(function () {
                var text = $("#searchstudenttext").val();
                if (!text) return;
                $("#searchstudenttable").find("tbody").remove();
                $("#searchstudenttable").append('<tbody><tr><td colspan="4" class="text-center"><i class="fa fa-spinner fa-spin"></i> Loading...</td></tr></tbody>');
                getStudents(text);
            });

            $("#searchstudenttext").keyup(function (e) {
                if (e.keyCode === 13) { $("#searchstudentbutton").click(); }
            });
        });

        function getStudentNo(sn) {
            $("#studentno").val(sn);
            $("#searchstudentmodal").modal("hide");
        }

        function getStudents(searchtext) {
            $.ajax({
                type: "GET",
                url: "/SearchStudent/" + encodeURIComponent(searchtext),
                success: function (data) {
                    var tbl = $("#searchstudenttable");
                    tbl.find("tbody").remove();
                    var rows = '<tbody>';
                    $.each(data, function (i, val) {
                        rows += '<tr>'
                            + '<td><a href="#" onclick="getStudentNo(\'' + val.StudentNo + '\'); return false;">' + val.StudentNo + '</a></td>'
                            + '<td>' + val.LastName + '</td>'
                            + '<td>' + val.FirstName + '</td>'
                            + '<td>' + val.Program + '</td>'
                            + '</tr>';
                    });
                    rows += '</tbody>';
                    tbl.append(rows);
                },
                error: function () {
                    $("#searchstudenttable").find("tbody").remove();
                    $("#searchstudenttable").append('<tbody><tr><td colspan="4" class="text-danger">Error loading students.</td></tr></tbody>');
                }
            });
        }
    </script>
}

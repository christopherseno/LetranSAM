@{
    ViewBag.Title = "AR Query Page";
}


<div class="p-3 content">
    <input type="button" class="btn btn-danger" id="studentfinderbutton" value="Student No Finder" />
    <h2>Student's Account Ledger</h2>
    <input type="text" id="studentno" placeholder="Student No" />
    <button class="btn btn-primary" id="search">Search</button>
    <div class="form-group">
        <div class="col-md-12">
            <input type="checkbox" id="Usedefault" name="Usedefault" /> Use Latest Enrollment
        </div>
    </div>
    <div id="studentdetail"></div>
    <p><table id="arquerytable" class="table table-striped table-bordered"></table></p>
    <div id="total"></div>
</div>

<div class="modal fade" tabindex="-1" id="searchstudentmodal" data-keyboard="false"
     data-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <span class="text-primary">Search Student</span>
                <button type="button" class="close" data-dismiss="modal">
                    &times;
                </button>

            </div>
            <div class="modal-body">
                <input type="text" id="searchstudenttext" placeholder="Enter last name  or firstname" />
                <button class="btn btn-primary" id="searchstudentbutton">Search</button>
                <button class="buttonload" style="display:none" id="searchstudentloading">
                    <i class="fa fa-spinner fa-spin"></i>Loading
                </button>
                <div class="table-responsive">
                    <table id="searchstudenttable" class="table table-striped table-bordered"><thead><tr><td>Student No</td><td>Last Name</td><td>First Name</td><td>Prgram</td></tr></thead></table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" data-dismiss="modal" class="btn btn-danger">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>

@section scripts
{

    <script type="text/javascript">
        $(document).ready(function () {
            $("#Usedefault").prop('checked', true);

            $("#search").click(function () {
                getARQuery();
            });
            $("#studentno").keyup(function (e) {
                if (e.keyCode == 13) {
                    getARQuery();
                }
            });
            $("#linkClose").click(function () {
                $("#divError").hide('fade');
            });
            $("#studentfinderbutton").click(function () {
                $("#searchstudenttext").val("");
                $('#searchstudenttable').empty();
                $("#searchstudentmodal").modal('show');
            });
            $("#searchstudentbutton").click(function () {
                getStudents($("#searchstudenttext").val());
            });
        });
        function getStudentNo(sn) {
            $("#studentno").val(sn);
            $("#searchstudentmodal").modal('hide');
        }
        function getStudents(searchtext) {
            $.ajax({
                type: "GET",
                url: "https://api.letran.edu.ph/SearchStudent/" + searchtext,                
                beforeSend: function (data) {
                    $("#searchstudentloading").css("display", "inline");
                },
                complete: function (data) {
                    $("#searchstudentloading").css("display", "none");
                },
                success: function (data) {

                    var searchstudenttable = $('#searchstudenttable');
                    searchstudenttable.empty();
                    searchstudenttable.append('<thead class="thead-dark"><tr><th>Student No</th><th>Last Name</th><th>First Name</th>' +
                        '<th>Program</th></tr ></thead > <tbody>');
                    $.each(data, function (index, val) {
                        searchstudenttable.append('<tr><td><a href="#" onclick="getStudentNo(' + val.StudentNo + ')">' + val.StudentNo + '</a></td><td>' + val.LastName + '</td>' +
                            '<td>' + val.FirstName + '</td><td>' + val.Program + '</td></tr>');
                    });
                },
                error: function (data) {

                }
            });
        }

        function getARQuery() {            
            var periodid = $("#Usedefault").is(":checked") ? 0 : $("#PeriodId").val();
            var studentno = $("#studentno").val();
            var arquerytable = $("#arquerytable");
            var studentdetail = $("#studentdetail");
            var total = $("#total");
            $.ajax({
                type: "GET",
                url: "https://api.letran.edu.ph/Assessment/ARQueryByFinance/" + studentno + "/" + periodid,
                beforeSend: function (data) {
                    Codebase.layout('header_loader_on');
                },
                complete: function (data) {
                    Codebase.layout('header_loader_off');
                },
                success: function (data) {
                    arquerytable.empty();
                    arquerytable.append('<thead class="thead-dark"><tr><th>Particular</th><th>Debit</th><th>Credit</th>' +
                        '<th>Doc No</th><th>Doc Date</th><th>Remarks</th></tr ></thead > <tbody>');
                    $.each(data.ARItems, function (index, val) {

                        arquerytable.append('<tr><td>' + val.Particular + '</td><td align="right">' + (val.Debit === 0 ? "" : toCurrency(val.Debit)) + '</td>' +
                            '<td align="right">' + (val.Credit === 0 ? "" : toCurrency(val.Credit)) + '</td><td>' + (val.DocumentNo === null ? "" : val.DocumentNo) + '</td>' +
                            '<td>' + (val.DocumentDate === null ? "" : getFormattedDate(new Date(val.DocumentDate))) + '</td><td>' + (val.Remark === null ? "" : val.Remark) + '</td></tr>');

                    });
                    arquerytable.append('</tbody>');
                    studentdetail.empty();
                    studentdetail.append('<h2>' + data.Student.StudentName + '</h2>');
                    studentdetail.append('<h3>School Year: ' + (data.Student.Period === null ? "" : data.Student.Period)) + '</h1>';
                    studentdetail.append('<br />Payment Mode: ' + (data.Student.PaymentMode === null ? "" : data.Student.PaymentMode));
                    studentdetail.append('<br />Program: ' + (data.Student.Program === null ? "" : data.Student.Program));
                    studentdetail.append('<br />Section: ' + (data.Student.Section === null ? "" : data.Student.Section));
                    studentdetail.append('<br />Status: ' + (data.Student.Status === null ? "" : data.Student.Status));
                    studentdetail.append('<br />Assessment Date: ' + (data.Student.AssessmentDate === null ? "" : getFormattedDate(new Date(data.Student.AssessmentDate))));
                    studentdetail.append('<br />Validation Date: ' + (data.Student.ValidationDate === null ? "" : getFormattedDate(new Date(data.Student.ValidationDate))));
                    if (data.Student.AssessmentId === null) {
                        studentdetail.append('<br />');
                    }
                    else {
                        studentdetail.append('<br /><a href="AddDMCM/' + data.Student.AssessmentId + '" class="btn btn-primary">Add D/C Memo</a>');
                    }
                    total.empty();
                    total.append('Total Debit:  ' + toCurrency(data.TotalDebit));
                    total.append('<br />Total Credit:  ' + toCurrency(data.TotalCredit));
                    total.append('<h2>Balance:  ' + toCurrency(data.TotalBalance) + '</h2>');
                    total.append('<a href="PrintSOA/' + data.Student.AssessmentId + '" class="btn btn-primary">Print SOA</a>');
                    total.append('<a href="CloseSpecificAR/' + data.Student.AssessmentId + '" class="btn btn-primary">Close this AR</a>');
                },
                error: function (data, x, y) {
                    
                    $("#arqueryloading").css("display", "none");
                    var error = JSON.parse(data.responseText);
                    Swal.fire(error.Message);
                    arquerytable.empty();
                    total.empty();
                    studentdetail.empty();
                    Codebase.layout('header_loader_off');

                }
            });
        }


    </script>
}


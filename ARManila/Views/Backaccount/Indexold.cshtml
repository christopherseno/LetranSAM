@model List<ARManila.Models.BackaccountWrapper>

@{
    ViewBag.Title = "Index";
}

<div class="content">
    <h2>View Backaccount</h2>
    @using (Html.BeginForm("Index", "Backaccount", FormMethod.Post))
    {
        <input type="button" class="btn btn-danger" id="studentfinderbutton" value="Student No Finder" />
        <br />
        <input type="text" placeholder="Student Number" name="id" id="id" />
        <input type="submit" value="Search" class="btn btn-primary" />
    }
    <br />
    @if (Model != null && Model.Count > 0)
    {
        <h2>
            Student's Backaccount History
            <button class="buttonload" style="display:none" id="deletebackaccountloading">
                <i class="fa fa-spinner fa-spin"></i>Processing
            </button>
        </h2>
        <p>
            Student No: @Model.FirstOrDefault().StudentNo
            <br />
            Student Name: @Model.FirstOrDefault().StudentName
        </p>
        <table class="table table-bordered" id="table">
            <thead>
                <tr>
                    <th>
                        Backaccount From
                    </th>
                    <th>
                        Amount
                    </th>
                    <th>
                        Forwarded To
                    </th>
                    <th></th>
                    <th></th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                @foreach (var item in Model)
                {
                    var a = "key" + item.BackaccountId;
                    <tr>
                        <td>
                            @Html.DisplayFor(modelItem => item.Period)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.Amount)
                        </td>
                        <td>
                            @Html.DisplayFor(modelItem => item.AssessmentPeriod)
                        </td>
                        <td>
                            <button data-toggle="collapse" data-target="#@a">View Details</button>
                            <br />
                            <div id="@a" class="collapse">
                                @if (item.BackaccountPaymentWrappers.Count > 0)
                                {
                                    <table class="table table-bordered">
                                        <tr>
                                            <th>OR No</th>
                                            <th>Transaction Date</th>
                                            <th>Amount</th>
                                            <th></th>
                                        </tr>
                                        @foreach (var detail in item.BackaccountPaymentWrappers)
                                        {
                                            <tr>
                                                <td>@detail.ORNo</td>
                                                <td>@detail.PaymentDate</td>
                                                <td>@detail.Amount</td>
                                                <td> @Html.ActionLink("Unlink Payment", "UnlinkBackaccountPayment", "Backaccount", new { id = detail.BackaccountPaymentId }, new { @class = "btn btn-primary" })</td>
                                            </tr>

                                        }
                                    </table>
                                }
                                else
                                {
                                    <span>No Payment associated with this backaccount</span>
                                }
                            </div>
                        </td>
                        <td>
                            @Html.ActionLink("Edit", "Edit", new { id = item.BackaccountId })
                        </td>
                        <td>
                            <a href="#" class="btn btn-primary" onclick="deletebackaccount(@item.BackaccountId)" data-toggle="modal" data-target="#confirm-submit">Delete</a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }
</div>
<div class="modal fade" id="confirm-submit" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirm Delete</h2>
            </div>
            <div class="modal-body">
                Are you sure you want to delete this backaccount?
                <table class="table">
                    <tr>
                        <th>Period</th>
                        <td id="Period"></td>
                    </tr>
                    <tr>
                        <th>Amount</th>
                        <td id="Amount"></td>
                    </tr>
                </table>

            </div>

            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <a href="#" id="submit" class="btn btn-success success">Submit</a>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" tabindex="-1" id="searchstudentmodal" data-keyboard="false"
     data-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <span class="text-primary">Search Student</span>
                <button type="button" class="close" data-dismiss="modal">
                    &times;
                </button>

            </div>
            <div class="modal-body">
                <input type="text" id="searchstudenttext" placeholder="Enter last name  or firstname" />
                <button class="btn btn-primary" id="searchstudentbutton">Search</button>
                <button class="buttonload" style="display:none" id="searchstudentloading">
                    <i class="fa fa-spinner fa-spin"></i>Loading
                </button>
                <div class="table-responsive">
                    <table id="searchstudenttable" class="table table-striped table-bordered"><thead><tr><td>Student No</td><td>Last Name</td><td>First Name</td><td>Prgram</td></tr></thead></table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" data-dismiss="modal" class="btn btn-danger">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
@section scripts
{
    <script type="text/javascript">
        var backaccountidfordeletion = 0;
        function deletebackaccount (backaccountid) {
            var backaccountarray = @Html.Raw(Json.Encode(Model));
            for (var i = 0; i < backaccountarray.length; i++) {
                if (backaccountarray[i].BackaccountId == backaccountid) {
                    $('#Period').text((backaccountarray[i].Period));
                    $('#Amount').text((backaccountarray[i].Amount));
                    backaccountidfordeletion = backaccountarray[i].BackaccountId;
                }
            }
        }

        $('#submit').click(function () {
            window.location.href = '@Url.Action("DeleteBackaccount", "Backaccount")/' + backaccountidfordeletion;
            //$.ajax({
            //    type: "GET",
            //    url: "/Backaccount/DeleteBackaccount/" + backaccountidfordeletion,
            //    beforeSend: function (data) {
            //        $("#deletebackaccountloading").css("display", "inline");
            //    },
            //    complete: function (data) {
            //        $("#deletebackaccountloading").css("display", "none");
            //    },
            //    success: function (data) {

            //    },
            //    error: function (data) {
            //        alert("Error");
            //        $("#deletebackaccountloading").css("display", "none");
            //    }
            //});
        });
    </script>
    <script type="text/javascript">
        $(document).ready(function () {
            $("#studentfinderbutton").click(function () {
                $("#searchstudenttext").val("");
                $('#searchstudenttable').empty();
                $("#searchstudentmodal").modal('show');
            });
            $("#searchstudentbutton").click(function () {
                getStudents($("#searchstudenttext").val());
            });
        });
        function getStudentNo(sn) {
            $("#studentno").val(sn);
        }
        function getStudents(searchtext) {
            $.ajax({
                type: "GET",
                url: "https://api.letran.edu.ph/SearchStudent/" + searchtext,
                headers: {Authorization: 'Bearer @ViewBag.session.ToString()'},
                beforeSend: function (data) {
                    $("#searchstudentloading").css("display", "inline");
                },
                complete: function (data) {
                    $("#searchstudentloading").css("display", "none");
                },
                success: function (data) {

                    var searchstudenttable = $('#searchstudenttable');
                    searchstudenttable.empty();
                    searchstudenttable.append('<thead class="thead-dark"><tr><th>Student No</th><th>Last Name</th><th>First Name</th>' +
                        '<th>Program</th></tr ></thead > <tbody>');
                    $.each(data, function (index, val) {
                        searchstudenttable.append('<tr><td><a href="#" onclick="getStudentNo(' + val.StudentNo + ')">' + val.StudentNo + '</a></td><td>' + val.LastName + '</td>' +
                            '<td>' + val.FirstName + '</td><td>' + val.Program + '</td></tr>');
                    });
                },
                error: function (data) {

                }
            });
        }
    </script>
}
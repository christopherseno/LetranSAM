@model ARManila.Models.Payment

@{
    ViewBag.Title = "Create";
}
<div class="p-4 content">
    <form method="post">
        <div class="form-horizontal">
            <h4>Post Payment</h4>
            <hr />

            <div class="form-group">
                <span class="control-label col-md-2">Level</span>
                <div class="col-md-10">
                    @Html.DropDownList("EducationalLevelId", null, htmlAttributes: new { @class = "col-md-3" })
                    @Html.DropDownList("SchoolYearId", null, htmlAttributes: new { @class = "col-md-3" })
                    @Html.DropDownList("LearningTypeId", null, htmlAttributes: new { @class = "col-md-3" })
                </div>
            </div>
            <div class="form-group">
                <span class="control-label col-md-2">Period</span>
                <div class="col-md-10">
                    <select class="form-control" id="Period" name="Period"></select>
                </div>
            </div>
            <div class="form-group">
                <label for="ORNo" class="control-label col-md-2">Reference No</label>
                <div class="col-md-10">
                    @Html.EditorFor(model => model.ORNo, new { htmlAttributes = new { @class = "form-control" } })
                </div>
            </div>


            <div class="form-group">
                <label for="StudentNo" class="control-label col-md-2">Student No</label>
                <div class="col-md-10">
                    <input type="text" id="StudentNo" placeholder="Student No" class="form-control" />
                    <div id="studentdetail"></div>
                    <input type="button" class="btn btn-danger" id="studentfinderbutton" value="Student No Finder" />
                </div>
            </div>
            <div class="form-group">
                <label for="StudentNo" class="control-label col-md-2">Student Name</label>
                <div class="col-md-10">
                    <input type="text" id="studentname" class="form-control" />
                </div>
            </div>
            <div class="form-group" id="studentnamegroup">
                <label for="StudentNo" class="control-label col-md-2">Email</label>
                <div class="col-md-10">
                    <input type="email" id="StudentEmail" name="StudentEmail" class="form-control" />
                </div>
            </div>
            <div class="form-group">
                <label for="TransactionDate" class="control-label col-md-2">Posting Date</label>
                <div class="col-md-10">
                    @Html.EditorFor(model => model.TransactionDate, new { htmlAttributes = new { @class = "form-control", type = "Date" } })
                </div>
            </div>

            <div class="form-group">
                @Html.LabelFor(model => model.Bank, htmlAttributes: new { @class = "control-label col-md-2" })
                <div class="col-md-10">
                    @Html.DropDownList("BankID", (IEnumerable<SelectListItem>)ViewBag.Banks, htmlAttributes: new { @class = "form-control" })

                </div>
            </div>

            <div class="form-group">
                <label for="Amount" class="control-label col-md-2">Amount</label>
                <div class="col-md-10">
                    @Html.EditorFor(model => model.Amount, new { htmlAttributes = new { @class = "form-control" } })
                </div>
            </div>

            <div class="form-group">
                @Html.LabelFor(model => model.Remarks, htmlAttributes: new { @class = "control-label col-md-2" })
                <div class="col-md-10">
                    @Html.EditorFor(model => model.Remarks, new { htmlAttributes = new { @class = "form-control" } })
                    @Html.ValidationMessageFor(model => model.Remarks, "", new { @class = "text-danger" })
                </div>
            </div>

            <div class="form-group">
                <label for="BankDate" class="control-label col-md-2">Bank Date</label>
                <div class="col-md-10">
                    @Html.EditorFor(model => model.BankDate, new { htmlAttributes = new { @class = "form-control", type = "date" } })
                </div>
            </div>

            <div class="row">
                <h4>Payment Details</h4>
                <div class="dropdown">
                    <button class="btn btn-primary dropdown-toggle" type="button" data-toggle="dropdown">
                        Paycode List
                        <span class="caret"></span>
                    </button>
                    <ul class="dropdown-menu">
                        <input class="form-control" id="myInput" type="text" placeholder="Search..">
                        @foreach (var i in (List<UAC.ProjectOne.Paycode>)ViewBag.Paycodes)
                        {
                            <li><a href="#" onclick="addpaymentdetail({PaycodeID:'@i.PaycodeID', Description:'@i.Description', Amount:'@i.Amount'})">@i.Description</a></li>
                        }

                    </ul>
                </div>
                <table id="paymentdetailtable" class="table table-bordered table-striped">
                    <thead>
                        <tr><th hidden>ID</th><th>Description</th><th style="text-align:center">Amount</th><th></th></tr>
                    </thead>
                </table>
            </div>


            <div class="form-group">
                <div class="col-md-offset-2 col-md-10">
                    <input type="button" value="  Post  " class="btn btn-primary" id="PostPayment" />
                    <button class="buttonload" style="display:none" id="saving">
                        <i class="fa fa-spinner fa-spin"></i>Saving...
                    </button>
                </div>
            </div>
        </div>

    </form>

    <div>
        @Html.ActionLink("Back to List", "Index")
    </div>
</div>
<dialog id="PaycodeAmountDialog">
    <div>
        <input type="number" id="paycodeamount" placeholder="Enter Amount" />
        <br />
        <button id="confirmBtn" value="default" onclick="closeDialog()">Confirm</button>
    </div>
</dialog>
<div class="modal fade bd-example-modal-sm" tabindex="-1" id="paycodeamountmodal" data-keyboard="false"
     data-backdrop="static">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <span class="text-primary">Enter Amount</span>
                <button type="button" class="close" data-dismiss="modal">
                    &times;
                </button>

            </div>
            <div class="modal-body">
                <input type="number" id="paycodeamount2" placeholder="Enter Amount" />
                <button class="btn btn-primary" id="searchstudentbutton">Enter</button>
            </div>
            <div class="modal-footer">
                <button type="button" data-dismiss="modal" class="btn btn-danger">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
<div class="modal fade" tabindex="-1" id="searchstudentmodal" data-keyboard="false"
     data-backdrop="static">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <span class="text-primary">Search Student</span>
                <button type="button" class="close" data-dismiss="modal">
                    &times;
                </button>

            </div>
            <div class="modal-body">
                <input type="text" id="searchstudenttext" placeholder="Enter last name  or firstname" />
                <button class="btn btn-primary" id="searchstudentbutton2">Search</button>
                <button class="buttonload" style="display:none" id="searchstudentloading">
                    <i class="fa fa-spinner fa-spin"></i>Loading
                </button>
                <div class="table-responsive">
                    <table id="searchstudenttable" class="table table-striped table-bordered"><thead><tr><td>Student No</td><td>Last Name</td><td>First Name</td><td>Prgram</td></tr></thead></table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" data-dismiss="modal" class="btn btn-danger">
                    Close
                </button>
            </div>
        </div>
    </div>
</div>
@section scripts {
    <script type="text/javascript">
        $(document).ready(function () {
                var periods = new Array();
        var periodarray = @Html.Raw(Json.Encode(ViewBag.Period));
    for (var i = 0; i < periodarray.length; i++) {
        periods[i] = periodarray[i];
    }
    LoadPeriod($("#SchoolYearId").val(), $("#EducationalLevelId").val(), $("#LearningTypeId").val());
    $("#SchoolYearId").change(function () {
        LoadPeriod($("#SchoolYearId").val(), $("#EducationalLevelId").val(), $("#LearningTypeId").val());
    });
    $("#EducationalLevelId").change(function () {
        LoadPeriod($("#SchoolYearId").val(), $("#EducationalLevelId").val(), $("#LearningTypeId").val());
    });
    $("#LearningTypeId").change(function () {
        LoadPeriod($("#SchoolYearId").val(), $("#EducationalLevelId").val(), $("#LearningTypeId").val());
    });
    function LoadPeriod(schoolyearid, educationallevelid, learningtypeid)
    {
        $("#Period").empty();

        for (var i = 0; i < periodarray.length; i++) {

            if (periodarray[i].SchoolYearId == schoolyearid && periodarray[i].EducationalLevelId == educationallevelid && periodarray[i].LearningTypeId == learningtypeid) {
                var option = $("<option />");
                option.attr("value", periodarray[i].PeriodId).text(periodarray[i].PeriodName);
                $("#Period").append(option);

            }
        }
    }
            $("#studentfinderbutton").click(function () {
                $("#searchstudenttext").val("");
                $('#searchstudenttable').empty();
                $("#searchstudentmodal").modal('show');
            });
            $("#searchstudentbutton2").click(function () {
                getStudents($("#searchstudenttext").val());
            });
            $("#PostPayment").click(function () {
                postPayment();
            });
            $("#myInput").on("keyup", function () {
                var value = $(this).val().toLowerCase();
                $(".dropdown-menu li").filter(function () {
                    $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
                });
            });
            $("#searchstudentbutton").click(function () {
                addPaymentDetail();
            });
        });

        function getStudentNo(sn, name, email) {
            $("#StudentNo").val(sn);
            $("#studentname").val(name);
            $("#StudentEmail").val(email);
        }
        function getStudents(searchtext) {
            $.ajax({
                type: "GET",
                url: "/api/StudentSearch/" + searchtext,
                beforeSend: function (data) {
                    $("#searchstudentloading").css("display", "inline");
                },
                complete: function (data) {
                    $("#searchstudentloading").css("display", "none");
                },
                success: function (data) {

                    var searchstudenttable = $('#searchstudenttable');
                    searchstudenttable.empty();
                    searchstudenttable.append('<thead class="thead-dark"><tr><th>Student No</th><th>Last Name</th><th>First Name</th>' +
                        '<th>Program</th></tr ></thead > <tbody>');
                    $.each(data, function (index, val) {
                        var x = " " + val.StudentNo;
                        searchstudenttable.append('<tr><td><a href="#" onclick="getStudentNo(' + x + ',\'' + val.FirstName + ' ' + val.LastName + '\',\'' + val.Email+'\')">' + val.StudentNo + '</a></td><td>' + val.LastName + '</td>' +
                            '<td>' + val.FirstName + '</td><td>' + val.Program + '</td></tr>');
                    });
                },
                error: function (data) {

                }
            });
        }
        function getStudentInfo() {

            var periodid = localStorage.getItem('Period');
            var studentno = $("#StudentNo").val();
            var studentname = $("#studentname");
            var studentnamegroup = $("#studentnamegroup");

            $.ajax({
                type: "GET",
                url: "/api/StudentInfo/" + studentno + "?periodid=" + periodid,
                beforeSend: function (data) {
                    $("#studentloading").css("display", "inline");
                },
                complete: function (data) {
                    $("#studentloading").css("display", "none");
                },
                success: function (data) {
                    studentname.val(data.StudentName + " (" + data.EducationalLevel + ")");
                    studentnamegroup.css("display", "block");
                },
                error: function (data) {
                    alert("Error\n" + "Not Found");
                    studentname.val("");
                    studentnamegroup.css("display", "none");
                    $("#studentloading").css("display", "none");

                }
            });
        }

        function postPayment() {
            if ($("#Period option").length < 1) {
                alert("No item selected");
            }
            else { 
            var paymentdata = new Object();
            var paymentdetail = new Object();
            paymentdata.TransactionNo = $("#ORNo").val();
            paymentdata.StudentNo = $("#StudentNo").val();
            paymentdata.PostingDate = $("#TransactionDate").val();
            paymentdata.BankDate = $("#BankDate").val();
            paymentdata.Amount = $("#Amount").val();
            paymentdata.Remark = $("#Remarks").val();
            paymentdata.BankId = $("#BankID").val();
            paymentdata.Email = $("#StudentEmail").val();
            //paymentdata.EmployeeNo = "13061025";
            paymentdata.PaymentId = 0;
            paymentdata.PeriodId = $("#Period").val();
            paymentdata.paymentDetails = [];
            //paymentdetail.PaycodeId = 1;
            //paymentdetail.Amount = 555;
            //paymentdata.paymentDetails[0] = paymentdetail;
            //paymentdetail = new Object();
            //paymentdetail.PaycodeId = 0;
            //paymentdetail.Amount = 1000;
            //paymentdata.paymentDetails[1] = paymentdetail;
            var paymentdetailtable = $("#paymentdetailtable");

            for (var i = 1; i < document.getElementById("paymentdetailtable").rows.length; i++) {
                var row = document.getElementById("paymentdetailtable").rows[i];
                //paymentdetail = new Object();
                var PaycodeId = document.getElementById("paymentdetailtable").rows[i].cells[0].innerHTML.replace(",", "");
                var Amount = document.getElementById("paymentdetailtable").rows[i].cells[2].innerHTML.replace(",", "");

                paymentdata.paymentDetails.push({ "PaycodeId": PaycodeId, "Amount": Amount });
            }
            $.ajax({
                type: "POST",
                url: "/api/BankPayment/",
                dataType: 'json',
                data: paymentdata,
                beforeSend: function (data) {
                    $("#saving").css("display", "inline");
                },
                complete: function (data) {
                    $("#saving").css("display", "none");
                },
                success: function (data) {
                    alert("Success");
                    window.location.href = "/Payments/Details/" + data.PaymentId;
                },
                error: function (jqXhr, textStatus, errorThrown) {
                    var error = $.parseJSON(jqXhr.responseText);
                    alert(jqXhr.status + "\n" + textStatus + "\n" + errorThrown);
                    $("#saving").css("display", "none");
                }
            });
        }
        }
        function addpaymentdetail(item) {
            var paymentdetailtable = $("#paymentdetailtable");
            if (item.Amount === null || item.Amount == null || item.Amount == undefined || item.Amount == "") {
                //document.getElementById("PaycodeAmountDialog").showModal();
                $("#paycodeamountmodal").modal('show');
            }
            paymentdetailtable.append("<tr><td hidden>" + item.PaycodeID + "</td><td>" + item.Description + "</td><td align='center'>" + (item.Amount == null ? "" : toCurrency(Number(item.Amount))) + "</td><td align='center'><input type='button' value='Delete' onclick='deleteRow(this)'></td></tr>");
        }
        function deleteRow(r) {
            var i = r.parentNode.parentNode.rowIndex;
            document.getElementById("paymentdetailtable").deleteRow(i);
        }
        function closeDialog() {
            var favDialog = document.getElementById('PaycodeAmountDialog');
            var amount = document.getElementById('paycodeamount').value;
            var table = document.getElementById('paymentdetailtable');
            var lastRow = table.rows[table.rows.length - 1];
            var cell = lastRow.cells[2];
            cell.innerHTML = toCurrency(Number(amount));
            document.getElementById('paycodeamount').value = "";
            favDialog.close();
        }
        function addPaymentDetail() {
            //var favDialog = document.getElementById('PaycodeAmountDialog');
            var amount = document.getElementById('paycodeamount2').value;
            var table = document.getElementById('paymentdetailtable');
            var lastRow = table.rows[table.rows.length - 1];
            var cell = lastRow.cells[2];
            cell.innerHTML = toCurrency(Number(amount));
            document.getElementById('paycodeamount2').value = "";
            $("#paycodeamountmodal").modal('hide');
        }
    </script>
}
